<script type="text/javascript">

	const electron = window.require('electron');
	const ipcRenderer  = electron.ipcRenderer;
	const axios 	= require('axios');

	const baseUrl =  'http://localhost'; //'http://ec2-13-57-32-222.us-west-1.compute.amazonaws.com';

	var user = null;

	// Register
	ipcRenderer.on('postRegisterRequest', (event, arg) => {
		axios.post(baseUrl+'/register', {
			firstName: 				arg.firstName,
			lastName: 				arg.lastName,
			email: 						arg.email,
			password: 				arg.password,
			password_confirmation: 			arg.confirmPassword,
		})
		.then(function (response) {
			ipcRenderer.send('snackbarMessage', "Registered, waiting approval.");
		})
		.catch(function (error) {
			ipcRenderer.send('snackbarMessage', "Unable to register, please contact administrator.");
		});
	});

	// Login
	ipcRenderer.on('getLoginRequest', (event, arg) => {
		console.log(baseUrl+'/login');
		console.log(arg.email);
		axios.get(baseUrl+'/login', {
		params: {
				email: 		arg.email,
				password: arg.password,
			}
		})
		.then(function (response) {
			if ( response.data.result.userId && response.data.result.token)
			{
				console.log(response);
				axios.defaults.headers.common['Authorization'] = 'Bearer ' + response.data.result.token;
				const userId = response.data.result.userId;
				// Prep app for initial resource loading
				ipcRenderer.send('loginSuccess');

				// Fetch user basic information
				axios.get(baseUrl+'/users/'+userId)
				.then(function (response) {
					user = response.data.result[0];
					ipcRenderer.send('userInfoSuccess', response.data.result);
				})
				.catch(function (error) {
					ipcRenderer.send('snackbarMessage', "Unable to login, please contact administrator.");
				});
			}
			else 
				ipcRenderer.send('snackbarMessage', "Unable to login, please contact administrator.");	
		})
		.catch(function (error){
				ipcRenderer.send('snackbarMessage', "Unable to login, please contact administrator.");	
		});
	});
 
	// Get anouncements
	ipcRenderer.on('getAnnouncementsRequest', (event) => {
		axios.get(baseUrl+'/announcements')
		.then(function (response) {
			ipcRenderer.send('getAnnouncementsSuccess', response.data);
		})
		.catch(function (error) {
			ipcRenderer.send('getAnnouncementsFailure', error.response.data);
		});

	});

	// Get user avatar
	ipcRenderer.on('getUserAvatarRequest', (event) => {
		if(user.avatarId !== 0) {
			axios.get(baseUrl+'/users/'+user.id+'/images/'+user.avatarId, {
				responseType : 'arraybuffer'
			})
			.then(function (response) {

				var image = new Buffer(response.data, 'base64');

				// Get image name from header
				var imageName = response.headers["content-disposition"];
				var imageNameStart = imageName.search("=");
				imageName = imageName.slice(imageNameStart+1, imageName.length).replace(/['"]+/g, '');

				// return image and image name
				ipcRenderer.send('getUserAvatarSuccess', image);
			})
			.catch(function (error) {
				console.log(error);
			});
		}
	});

	// Get user image
	ipcRenderer.on('getUserImageRequest', (event, imageId) => {
		axios.get(baseUrl+'/users/'+user.id+'/images/'+imageId, {
			responseType : 'arraybuffer'
		})
		.then(function (response) {
			var image = new Buffer(response.data, 'base64');

			// return image and image id
			ipcRenderer.send('getUserImageSuccess', image, imageId);
		})
		.catch(function (error) {
			console.log(error);
		});
	});

	// Post user image
	ipcRenderer.on('postImagesRequest', (event, imageBase64, imageType) => {
		const extension = imageType.split("image/")[1];
		axios.post(baseUrl+'/users/'+user.id+'/images', {
			imageBase64: 	imageBase64,
			extension: 		extension,
		})
		.then(function (response) {
			ipcRenderer.send('postImagesSuccess', response.data.result);
			ipcRenderer.send('snackbarMessage', "(OK) The image is uploaded.");	
		})
		.catch(function (error) {
			console.log(error);
		});
	});

	// Delete user image
	ipcRenderer.on('deleteImagesRequest', (event, imageId) => {
		axios.delete(baseUrl+'/users/'+user.id+'/images/'+imageId)
		.then(function (response) {
			ipcRenderer.send('deleteImagesSuccess', response.data.result);
		})
		.catch(function (error) {
			console.log(error);
		});
	});

	// Get mail request
	ipcRenderer.on('getGoogleMailRequest', (event, arg) => {
		axios.get('https://www.googleapis.com/gmail/v1/users/userId/messages', {
			userId: 				'me',
			maxResult: 			arg,
		})
		.then(function (response) {
			ipcRenderer.send('resultGoogleMailRequest', response.data);
		})
		.catch(function (error) {
			console.log(error);
		});
	});

	// Get manager resource
	ipcRenderer.on('getManagerResources', (event) => {
		axios.get(baseUrl+'/managers/resources')
		.then(function (response) {
			ipcRenderer.send('getManagerResourcesSuccess', response.data.result);
		})
		.catch(function (error) {
			console.log(error);
		});
	});

	// Get teacher resource
	ipcRenderer.on('getTeacherResources', (event) => {
		axios.get(baseUrl+'/teachers/resources')
		.then(function (response) {
			ipcRenderer.send('getTeacherResourcesSuccess', response.data.result);
		})
		.catch(function (error) {
			console.log(error);
		});
	});

	// Get another user image
	ipcRenderer.on('getAnotherUserImageRequest', (event, userId, imageId, localPath) => {
		axios.get(baseUrl+'/users/'+userId+'/images/'+imageId, {
			responseType : 'arraybuffer'
		})
		.then(function (response) {
			var image = new Buffer(response.data, 'base64');

			// return image and image id
			ipcRenderer.send('getImageSuccess', image, localPath);
		})
		.catch(function (error) {
			console.log(error);
		});
	});

	// Get another user avatar
	ipcRenderer.on('getAnotherUserAvatarRequest', (event, userId, localPath) => {
		axios.get(baseUrl+'/users/'+userId+'/avatar', {
			responseType : 'arraybuffer'
		})
		.then(function (response) {
			var image = new Buffer(response.data, 'base64');

			// return image and image id
			ipcRenderer.send('getImageSuccess', image, localPath);
		})
		.catch(function (error) {
			console.log(error);
		});
	});

	// Get a student image
	ipcRenderer.on('getStudentImageRequest', (event, studentId, imageId, localPath) => {
		axios.get(baseUrl+'/students/'+studentId+'/images/'+imageId, {
			responseType : 'arraybuffer'
		})
		.then(function (response) {
			var image = new Buffer(response.data, 'base64');

			// return image and image id
			ipcRenderer.send('requestSuccess', response.data);
		})
		.catch(function (error) {
			console.log(error);
		});
	});

	// Assign a student to a teacher
	ipcRenderer.on('assignStudentRequest', (event, teacherId, studentId) => {
		axios.post(baseUrl+'/teachers/'+teacherId+'/assign/'+studentId)
		.then(function (response) {
			ipcRenderer.send('snackbarMessage', "(OK) Student is assigned.");
		})
		.catch(function (error) {
			console.log(error);
		});
	});

	// Unassign a student from a teacher
	ipcRenderer.on('unAssignStudentRequest', (event, teacherId, studentId) => {
		axios.delete(baseUrl+'/teachers/'+teacherId+'/unassign/'+studentId)
		.then(function (response) {
			ipcRenderer.send('snackbarMessage', "(OK) Student is unassigned.");
		})
		.catch(function (error) {
			console.log(error);
		});
	});

	// Activate a user
	ipcRenderer.on('addUserRequest', (event, pUserId) => {
		axios.put(baseUrl+'/users/'+pUserId+'/activate')
		.then(function (response) {
			ipcRenderer.send('snackbarMessage', "(OK) User is activated.");
		})
		.catch(function (error) {
			ipcRenderer.send('snackbarMessage', "Cannot activate user or user is already activated.");
		});
	});

	// Add a student
	ipcRenderer.on('addStudentRequest', (event, firstName, lastName, DoB) => {
		axios.post(baseUrl+'/students', {
			firstName: 				firstName,
			lastName: 				lastName,
			DoB: 							DoB
		})
		.then(function (response) {
			ipcRenderer.send('snackbarMessage', "(OK) Student is added.");
		})
		.catch(function (error) {
			ipcRenderer.send('snackbarMessage', "Cannot add student.");
		});
	});

	// Add a report
	ipcRenderer.on('addReportRequest', (event, report, studentId) => {
		axios.post(baseUrl+'/reports', {
			studentId: 		studentId,
			report: 			report,
		})
		.then(function (response) {
			ipcRenderer.send('snackbarMessage', "(OK) Report is submitted.");
		})
		.catch(function (error) {
			ipcRenderer.send('snackbarMessage', "Cannot submit report.");
		});
	});

</script>